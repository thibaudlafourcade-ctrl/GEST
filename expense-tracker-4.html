<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes de Frais - Auto-Reconnaissance</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151b3d;
            --bg-tertiary: #1e2749;
            --accent-cyan: #00f5ff;
            --accent-magenta: #ff0080;
            --accent-yellow: #ffd700;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --success: #00ff88;
            --warning: #ff9500;
            --error: #ff3366;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0f1435 50%, #1a1f45 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 245, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 0, 128, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-family: 'Space Mono', monospace;
            color: var(--text-secondary);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 2rem;
            animation: fadeIn 0.8s ease-out 0.2s backwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: rgba(21, 27, 61, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(0, 245, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 245, 255, 0.1);
        }

        .upload-zone {
            border: 3px dashed rgba(0, 245, 255, 0.3);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 245, 255, 0.02);
            position: relative;
            overflow: hidden;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 245, 255, 0.2), transparent);
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
        }

        .upload-zone:hover::before {
            width: 300px;
            height: 300px;
        }

        .upload-zone:hover {
            border-color: var(--accent-cyan);
            background: rgba(0, 245, 255, 0.05);
            transform: scale(1.02);
        }

        .upload-zone.dragover {
            border-color: var(--accent-magenta);
            background: rgba(255, 0, 128, 0.1);
            transform: scale(1.05);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        #fileInput {
            display: none;
        }

        .preview-section {
            margin-top: 2rem;
            display: none;
        }

        .preview-section.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .preview-image {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .form-section {
            position: relative;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.9rem 1.2rem;
            background: rgba(10, 14, 39, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
            background: rgba(10, 14, 39, 0.8);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        button {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 245, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: var(--bg-primary);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .status-message {
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .status-message.active {
            display: block;
        }

        .status-loading {
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .status-success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .status-error {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .expenses-list {
            margin-top: 2rem;
        }

        .expense-item {
            background: rgba(10, 14, 39, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease-out;
        }

        .expense-item:hover {
            border-color: var(--accent-cyan);
            transform: translateX(5px);
        }

        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .expense-amount {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .expense-category {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            background: rgba(0, 245, 255, 0.2);
            border-radius: 20px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .expense-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .expense-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-cyan);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .total-section {
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.1), rgba(255, 0, 128, 0.1));
            border: 2px solid rgba(0, 245, 255, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
            text-align: center;
        }

        .total-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .total-amount {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2.5rem;
            }

            .upload-zone {
                padding: 2rem 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì∏ Notes de Frais</h1>
            <p class="subtitle">Reconnaissance Automatique</p>
        </header>

        <div class="main-grid">
            <!-- Section Upload et Formulaire -->
            <div class="card">
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">D√©posez votre ticket ici</div>
                    <div class="upload-hint">ou cliquez pour s√©lectionner</div>
                    <input type="file" id="fileInput" accept="image/*" capture="environment">
                </div>

                <div class="preview-section" id="previewSection">
                    <img id="previewImage" class="preview-image" alt="Aper√ßu du ticket">
                    <button class="btn-primary" id="analyzeBtn" style="width: 100%;">
                        <span>üîç Analyser le ticket</span>
                    </button>
                </div>

                <div class="status-message" id="statusMessage"></div>

                <div class="form-section" id="formSection" style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--accent-cyan); font-size: 1.3rem;">üìã Informations g√©n√©rales</h3>
                    
                    <div class="form-group">
                        <label>Nom du collaborateur</label>
                        <input type="text" id="userName" placeholder="Votre nom complet">
                    </div>

                    <div class="form-group">
                        <label>Soci√©t√©</label>
                        <input type="text" id="companyName" placeholder="Nom de votre soci√©t√©">
                    </div>

                    <div class="form-group">
                        <label>P√©riode</label>
                        <input type="month" id="expensePeriod">
                    </div>

                    <h3 style="margin: 2rem 0 1.5rem 0; color: var(--accent-cyan); font-size: 1.3rem;">üí∞ D√©tails de la d√©pense</h3>

                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="expenseDate" required>
                    </div>

                    <div class="form-group">
                        <label>Cat√©gorie</label>
                        <select id="expenseCategory" required>
                            <option value="">S√©lectionner...</option>
                            <option value="Restaurant">üçΩÔ∏è Restaurant</option>
                            <option value="Transport">üöó Transport</option>
                            <option value="H√©bergement">üè® H√©bergement</option>
                            <option value="Fournitures">üì¶ Fournitures</option>
                            <option value="Carburant">‚õΩ Carburant</option>
                            <option value="Autres">üìã Autres</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Montant (‚Ç¨)</label>
                        <input type="number" id="expenseAmount" step="0.01" required placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label>Commer√ßant</label>
                        <input type="text" id="expenseMerchant" placeholder="Nom du commer√ßant">
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="expenseDescription" placeholder="D√©tails de la d√©pense..."></textarea>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" id="resetBtn">Annuler</button>
                        <button class="btn-success" id="saveBtn">üíæ Enregistrer</button>
                    </div>
                </div>
            </div>

            <!-- Section Liste des d√©penses -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; font-size: 1.8rem;">Mes Notes de Frais</h2>
                
                <div class="total-section">
                    <div class="total-label">Total des frais</div>
                    <div class="total-amount" id="totalAmount">0,00 ‚Ç¨</div>
                </div>

                <div class="expenses-list" id="expensesList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        Aucune note de frais enregistr√©e
                    </p>
                </div>

                <div class="button-group" style="margin-top: 2rem;">
                    <button class="btn-primary" id="exportBtn">üì• Exporter en PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const previewSection = document.getElementById('previewSection');
        const previewImage = document.getElementById('previewImage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const statusMessage = document.getElementById('statusMessage');
        const saveBtn = document.getElementById('saveBtn');
        const resetBtn = document.getElementById('resetBtn');
        const expensesList = document.getElementById('expensesList');
        const totalAmount = document.getElementById('totalAmount');
        const exportBtn = document.getElementById('exportBtn');

        let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
        let currentImageData = null;

        // Upload zone interactions
        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageUpload(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImageUpload(file);
            }
        });

        function handleImageUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageData = e.target.result;
                previewImage.src = currentImageData;
                previewSection.classList.add('active');
            };
            reader.readAsDataURL(file);
        }

        // Analyze ticket with Claude API
        analyzeBtn.addEventListener('click', async () => {
            if (!currentImageData) return;

            showStatus('loading', 'üîç Analyse du ticket en cours...');
            analyzeBtn.disabled = true;

            try {
                const base64Data = currentImageData.split(',')[1];
                const mediaType = currentImageData.split(';')[0].split(':')[1];

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: mediaType,
                                        data: base64Data
                                    }
                                },
                                {
                                    type: 'text',
                                    text: `Analyse ce ticket de caisse et extrais les informations suivantes au format JSON strict (sans markdown, sans backticks):
{
  "date": "YYYY-MM-DD",
  "amount": nombre d√©cimal,
  "merchant": "nom du commer√ßant",
  "category": "Restaurant|Transport|H√©bergement|Fournitures|Carburant|Autres",
  "description": "description courte"
}

Si une information n'est pas visible, mets une cha√Æne vide ou 0 pour le montant. R√©ponds uniquement avec le JSON, rien d'autre.`
                                }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                const textContent = data.content.find(c => c.type === 'text')?.text || '';
                
                // Parse the JSON response
                const cleanJson = textContent.replace(/```json\n?|\n?```/g, '').trim();
                const parsedData = JSON.parse(cleanJson);

                // Fill the form
                document.getElementById('expenseDate').value = parsedData.date || new Date().toISOString().split('T')[0];
                document.getElementById('expenseAmount').value = parsedData.amount || '';
                document.getElementById('expenseMerchant').value = parsedData.merchant || '';
                document.getElementById('expenseCategory').value = parsedData.category || '';
                document.getElementById('expenseDescription').value = parsedData.description || '';

                showStatus('success', '‚úÖ Ticket analys√© avec succ√®s !');
            } catch (error) {
                console.error('Error:', error);
                showStatus('error', '‚ùå Erreur lors de l\'analyse. Veuillez remplir manuellement.');
            } finally {
                analyzeBtn.disabled = false;
            }
        });

        function showStatus(type, message) {
            statusMessage.className = `status-message status-${type} active`;
            statusMessage.innerHTML = type === 'loading' ? 
                `<span class="loader"></span> ${message}` : message;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    statusMessage.classList.remove('active');
                }, 5000);
            }
        }

        // Save expense
        saveBtn.addEventListener('click', () => {
            const userName = document.getElementById('userName').value;
            const companyName = document.getElementById('companyName').value;
            const expensePeriod = document.getElementById('expensePeriod').value;

            // Save user info to localStorage for future use
            if (userName) {
                localStorage.setItem('userName', userName);
            }
            if (companyName) {
                localStorage.setItem('companyName', companyName);
            }
            if (expensePeriod) {
                localStorage.setItem('expensePeriod', expensePeriod);
            }

            const expense = {
                id: Date.now(),
                date: document.getElementById('expenseDate').value,
                category: document.getElementById('expenseCategory').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                merchant: document.getElementById('expenseMerchant').value,
                description: document.getElementById('expenseDescription').value,
                image: currentImageData,
                userName: userName,
                companyName: companyName,
                period: expensePeriod
            };

            if (!expense.date || !expense.category || !expense.amount) {
                showStatus('error', '‚ùå Veuillez remplir tous les champs obligatoires');
                return;
            }

            expenses.push(expense);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            
            showStatus('success', '‚úÖ Note de frais enregistr√©e !');
            resetForm();
            renderExpenses();
        });

        // Reset form
        resetBtn.addEventListener('click', resetForm);

        function resetForm() {
            // Keep user name, company and period
            const savedUserName = localStorage.getItem('userName');
            const savedCompanyName = localStorage.getItem('companyName');
            const savedPeriod = localStorage.getItem('expensePeriod');

            document.getElementById('expenseDate').value = '';
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseMerchant').value = '';
            document.getElementById('expenseDescription').value = '';
            
            // Restore user info
            if (savedUserName) {
                document.getElementById('userName').value = savedUserName;
            }
            if (savedCompanyName) {
                document.getElementById('companyName').value = savedCompanyName;
            }
            if (savedPeriod) {
                document.getElementById('expensePeriod').value = savedPeriod;
            }

            previewSection.classList.remove('active');
            currentImageData = null;
            fileInput.value = '';
        }

        // Render expenses
        function renderExpenses() {
            if (expenses.length === 0) {
                expensesList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Aucune note de frais enregistr√©e</p>';
                totalAmount.textContent = '0,00 ‚Ç¨';
                return;
            }

            const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            totalAmount.textContent = total.toFixed(2).replace('.', ',') + ' ‚Ç¨';

            expensesList.innerHTML = expenses.map(exp => `
                <div class="expense-item">
                    <div class="expense-header">
                        <span class="expense-amount">${exp.amount.toFixed(2).replace('.', ',')} ‚Ç¨</span>
                        <span class="expense-category">${exp.category}</span>
                    </div>
                    <div class="expense-details">
                        <div>üìÖ ${new Date(exp.date).toLocaleDateString('fr-FR')}</div>
                        <div>üè™ ${exp.merchant || 'N/A'}</div>
                    </div>
                    ${exp.description ? `<div style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">${exp.description}</div>` : ''}
                    <div class="expense-actions">
                        ${exp.image ? `<button class="btn-secondary btn-small" onclick="viewReceipt(${exp.id})">üëÅÔ∏è Voir ticket</button>` : ''}
                        <button class="btn-secondary btn-small" onclick="deleteExpense(${exp.id})">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
            `).join('');
        }

        window.viewReceipt = function(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense && expense.image) {
                const win = window.open('', '_blank');
                win.document.write(`
                    <html>
                        <head><title>Ticket - ${expense.merchant}</title></head>
                        <body style="margin: 0; background: #000; display: flex; justify-content: center; align-items: center; min-height: 100vh;">
                            <img src="${expense.image}" style="max-width: 100%; max-height: 100vh;">
                        </body>
                    </html>
                `);
            }
        };

        window.deleteExpense = function(id) {
            if (confirm('Voulez-vous vraiment supprimer cette note de frais ?')) {
                expenses = expenses.filter(e => e.id !== id);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                renderExpenses();
                showStatus('success', '‚úÖ Note de frais supprim√©e');
            }
        };

        // Export to PDF using jsPDF
        exportBtn.addEventListener('click', async () => {
            if (expenses.length === 0) {
                showStatus('error', '‚ùå Aucune note de frais √† exporter');
                return;
            }

            showStatus('loading', 'üìÑ G√©n√©ration du PDF en cours...');

            try {
                // Load jsPDF library and autoTable plugin dynamically
                if (typeof window.jspdf === 'undefined') {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Get user info
                const userName = localStorage.getItem('userName') || 'Non renseign√©';
                const companyName = localStorage.getItem('companyName') || '';
                const expensePeriod = localStorage.getItem('expensePeriod') || '';
                const periodText = expensePeriod ? new Date(expensePeriod + '-01').toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' }) : 'Non renseign√©e';

                // Header with background
                doc.setFillColor(10, 14, 39);
                doc.rect(0, 0, 210, 50, 'F');

                // Company name at top if provided
                if (companyName) {
                    doc.setFontSize(12);
                    doc.setTextColor(160, 174, 192);
                    doc.setFont(undefined, 'normal');
                    doc.text(companyName.toUpperCase(), 105, 12, { align: 'center' });
                }

                doc.setFontSize(28);
                doc.setTextColor(0, 245, 255);
                doc.setFont(undefined, 'bold');
                doc.text('NOTES DE FRAIS', 105, companyName ? 25 : 20, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(160, 174, 192);
                doc.setFont(undefined, 'normal');
                doc.text(`Date d'export: ${new Date().toLocaleDateString('fr-FR')}`, 105, companyName ? 33 : 28, { align: 'center' });

                // User information box
                let yPos = 55;
                const boxHeight = companyName ? 32 : 24;
                doc.setFillColor(245, 247, 250);
                doc.roundedRect(15, yPos, 180, boxHeight, 3, 3, 'F');

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                
                let infoY = yPos + 8;
                
                if (companyName) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Soci√©t√©:', 20, infoY);
                    doc.setFont(undefined, 'normal');
                    doc.text(companyName, 65, infoY);
                    infoY += 8;
                }

                doc.setFont(undefined, 'bold');
                doc.text('Collaborateur:', 20, infoY);
                doc.setFont(undefined, 'normal');
                doc.text(userName, 65, infoY);

                infoY += 8;
                doc.setFont(undefined, 'bold');
                doc.text('P√©riode:', 20, infoY);
                doc.setFont(undefined, 'normal');
                doc.text(periodText, 65, infoY);

                // Prepare table data
                const tableData = expenses.map(exp => {
                    const date = new Date(exp.date).toLocaleDateString('fr-FR');
                    const amount = exp.amount.toFixed(2) + ' ‚Ç¨';
                    const description = exp.description || '-';
                    
                    return [
                        date,
                        exp.category,
                        exp.merchant || 'N/A',
                        description,
                        amount
                    ];
                });

                // Calculate total
                const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);

                // Draw table using autoTable
                doc.autoTable({
                    startY: yPos + boxHeight + 10,
                    head: [['Date', 'Cat√©gorie', 'Commer√ßant', 'Description', 'Montant']],
                    body: tableData,
                    foot: [['', '', '', 'TOTAL', total.toFixed(2) + ' ‚Ç¨']],
                    theme: 'grid',
                    headStyles: {
                        fillColor: [0, 245, 255],
                        textColor: [10, 14, 39],
                        fontStyle: 'bold',
                        fontSize: 10,
                        halign: 'center'
                    },
                    bodyStyles: {
                        fontSize: 9,
                        textColor: [0, 0, 0]
                    },
                    footStyles: {
                        fillColor: [0, 245, 255],
                        textColor: [10, 14, 39],
                        fontStyle: 'bold',
                        fontSize: 11,
                        halign: 'right'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 247, 250]
                    },
                    columnStyles: {
                        0: { cellWidth: 25, halign: 'center' },
                        1: { cellWidth: 30 },
                        2: { cellWidth: 35 },
                        3: { cellWidth: 60 },
                        4: { cellWidth: 25, halign: 'right' }
                    },
                    margin: { left: 15, right: 15 },
                    didDrawPage: function(data) {
                        // Footer on each page
                        const pageCount = doc.internal.getNumberOfPages();
                        const pageSize = doc.internal.pageSize;
                        const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                        
                        doc.setFontSize(8);
                        doc.setTextColor(128, 128, 128);
                        doc.text(
                            `Page ${doc.internal.getCurrentPageInfo().pageNumber} / ${pageCount}`,
                            pageSize.width / 2,
                            pageHeight - 10,
                            { align: 'center' }
                        );
                    }
                });

                // Get final Y position after table
                const finalY = doc.lastAutoTable.finalY || 200;

                // Signature section
                if (finalY < 240) {
                    yPos = finalY + 20;
                } else {
                    doc.addPage();
                    yPos = 30;
                }

                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(15, yPos - 5, 195, yPos - 5);

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                doc.text('SIGNATURES', 105, yPos + 5, { align: 'center' });

                yPos += 15;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text('Collaborateur:', 30, yPos);
                doc.text('Responsable:', 125, yPos);

                yPos += 3;
                doc.text(`(${userName})`, 30, yPos);

                yPos += 15;
                doc.setLineWidth(0.3);
                doc.line(25, yPos, 80, yPos);
                doc.line(120, yPos, 175, yPos);

                yPos += 5;
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Date: __________________', 25, yPos);
                doc.text('Date: __________________', 120, yPos);

                // Save PDF
                const periodForFile = expensePeriod ? expensePeriod.replace('-', '_') : new Date().toISOString().slice(0, 7).replace('-', '_');
                const fileName = `notes_de_frais_${periodForFile}.pdf`;
                doc.save(fileName);

                showStatus('success', '‚úÖ PDF g√©n√©r√© avec succ√®s !');
            } catch (error) {
                console.error('PDF Error:', error);
                showStatus('error', '‚ùå Erreur lors de la g√©n√©ration du PDF');
            }
        });

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Initialize
        renderExpenses();
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        
        // Load saved user info
        const savedUserName = localStorage.getItem('userName');
        const savedCompanyName = localStorage.getItem('companyName');
        const savedPeriod = localStorage.getItem('expensePeriod');
        
        if (savedUserName) {
            document.getElementById('userName').value = savedUserName;
        }
        if (savedCompanyName) {
            document.getElementById('companyName').value = savedCompanyName;
        }
        if (savedPeriod) {
            document.getElementById('expensePeriod').value = savedPeriod;
        } else {
            // Set current month by default
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7);
            document.getElementById('expensePeriod').value = currentMonth;
        }
    </script>
</body>
</html>
